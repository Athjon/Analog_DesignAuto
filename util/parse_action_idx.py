from collections import OrderedDict
from numpy import array


def parse_action_idx(param_space, param_index):
    """
    Extract values from the param_space using index provided in param_index with validation.
    :param param_space: the param_space generated from the YAML file.
    :param param_index: the index of the required values.
    :return: OrderedDict: Extracted values based on the provided indices.
    :raise: ValueError: If keys in action_index do not correspond to keys in action_space.
    """
    param_dict = OrderedDict()

    # Validate if keys correspond between action_space and action_index
    for key in param_index:
        if key.startswith('M'):
            for param in ['w_', 'l_', 'nf_']:
                space_key = f"{param}{key}_per_finger" if param == 'w_' else f"{param}{key}"
                if space_key not in param_space:
                    print(f"Key {space_key} not found in param_space.")
                    raise ValueError(f"Key {key} not found in param_space.")
        else:
            if key not in param_space:
                print(f"Key {key} not found in param_space.")
                raise ValueError(f"Key {key} not found in param_space.")

    # Validate input index range (correct wrong index to the nearest available index if necessary) and extract data
    for key, index in param_index.items():
        if key.startswith('M'):
            for i, param in enumerate(['w_', 'l_', 'nf_']):
                space_key = f"{param}{key}_per_finger" if param == 'w_' else f"{param}{key}"
                if space_key in param_space:
                    value_range = len(param_space[space_key])
                    # e.g., index = [1 2 2]
                    corrected_index = min(max(index[i], 0), value_range - 1)
                    if index[i] != corrected_index:
                        print(f"Index {index[i]} out of range for key {key}, corrected to {corrected_index}.")
                    param_dict[space_key] = param_space[space_key][corrected_index]
        else:
            value_range = len(param_space[key])
            # e.g., index = [1], convert from array to int
            index = index[0]
            corrected_index = min(max(index, 0), value_range - 1)
            if index != corrected_index:
                print(f"Index {index} out of range for key {key}, corrected to {corrected_index}.")
            param_dict[key] = param_space[key][corrected_index]

    return param_dict


# Test Code
# test_space = OrderedDict([('w_M14_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u',
# '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']),
# ('l_M14', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u',
# '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M14', ['1', '2', '3', '4', '5', '6', '7', '8', '9',
# '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']), ('w_M35_per_finger', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('l_M35', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u',
# '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M35', ['1', '2',
# '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']),
# ('w_M25_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u',
# '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('l_M25', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('nf_M25', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14',
# '15', '16', '17', '18', '19', '20']), ('w_M13_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u',
# '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']),
# ('l_M13', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u',
# '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M13', ['1', '2', '3', '4', '5', '6', '7', '8', '9',
# '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']), ('w_M12_per_finger', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('l_M12', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u',
# '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M12', ['1', '2',
# '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']),
# ('w_M11_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u',
# '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('l_M11', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('nf_M11', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14',
# '15', '16', '17', '18', '19', '20']), ('w_M20_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u',
# '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']),
# ('l_M20', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u',
# '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M20', ['1', '2', '3', '4', '5', '6', '7', '8', '9',
# '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']), ('w_M19_per_finger', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('l_M19', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u',
# '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M19', ['1', '2',
# '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']),
# ('w_M36_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u',
# '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('l_M36', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('nf_M36', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14',
# '15', '16', '17', '18', '19', '20']), ('w_M16_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u',
# '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']),
# ('l_M16', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u',
# '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M16', ['1', '2', '3', '4', '5', '6', '7', '8', '9',
# '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']), ('w_M24_per_finger', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('l_M24', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u',
# '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M24', ['1', '2',
# '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']),
# ('w_M23_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u',
# '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('l_M23', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('nf_M23', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14',
# '15', '16', '17', '18', '19', '20']), ('w_M22_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u',
# '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']),
# ('l_M22', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u',
# '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M22', ['1', '2', '3', '4', '5', '6', '7', '8', '9',
# '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']), ('w_M21_per_finger', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('l_M21', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u',
# '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M21', ['1', '2',
# '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']),
# ('w_M18_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u',
# '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('l_M18', ['0.5u', '1.0u', '1.5u',
# '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u',
# '9.0u', '9.5u', '10.0u']), ('nf_M18', ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14',
# '15', '16', '17', '18', '19', '20']), ('w_M17_per_finger', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u',
# '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u', '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']),
# ('l_M17', ['0.5u', '1.0u', '1.5u', '2.0u', '2.5u', '3.0u', '3.5u', '4.0u', '4.5u', '5.0u', '5.5u', '6.0u', '6.5u',
# '7.0u', '7.5u', '8.0u', '8.5u', '9.0u', '9.5u', '10.0u']), ('nf_M17', ['1', '2', '3', '4', '5', '6', '7', '8', '9',
# '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']), ('IB', ['1.0u', '2.0u', '3.0u', '4.0u', '5.0u',
# '6.0u', '7.0u', '8.0u', '9.0u', '10.0u', '11.0u', '12.0u', '13.0u', '14.0u', '15.0u', '16.0u', '17.0u', '18.0u',
# '19.0u', '20.0u', '21.0u', '22.0u', '23.0u', '24.0u', '25.0u', '26.0u', '27.0u', '28.0u', '29.0u', '30.0u',
# '31.0u', '32.0u', '33.0u', '34.0u', '35.0u', '36.0u', '37.0u', '38.0u', '39.0u', '40.0u', '41.0u', '42.0u',
# '43.0u', '44.0u', '45.0u', '46.0u', '47.0u', '48.0u', '49.0u', '50.0u'])])
# test_index = OrderedDict( [('M13',
# array([8, 8, 99])), ('M14', array([1, 2, 2])), ('M16', array([1, 2, 2])), ('M23', array([0, 0, 0])), ('M24',
# array([1, 1, 1])), ('M25', array([2, 2, 1])), ('M35', array([2, 1, 2])), ('M36', array([2, 0, 2])), ('M17',
# array([2, 1, 1])), ('M18', array([1, 2, 1])), ('M11', array([0, 0, 1])), ('M12', array([2, 1, 0])), ('M19',
# array([2, 1, 2])), ('M20', array([1, 1, 0])), ('M21', array([1, 1, 0])), ('M22', array([0, 2, 1])), ('IB',
# array([99]))])
# test_result = parse_action_idx(test_space, test_index) print(test_result)

# Output
# Index 99 out of range for key M13, corrected to 19.
# Index 99 out of range for key IB, corrected to 49.
# OrderedDict([('w_M13_per_finger', '4.5u'), ('l_M13', '4.5u'), ('nf_M13', '20'), ('w_M14_per_finger', '1.0u'),
# ('l_M14', '1.5u'), ('nf_M14', '3'), ('w_M16_per_finger', '1.0u'), ('l_M16', '1.5u'), ('nf_M16', '3'),
# ('w_M23_per_finger', '0.5u'), ('l_M23', '0.5u'), ('nf_M23', '1'), ('w_M24_per_finger', '1.0u'), ('l_M24', '1.0u'),
# ('nf_M24', '2'), ('w_M25_per_finger', '1.5u'), ('l_M25', '1.5u'), ('nf_M25', '2'), ('w_M35_per_finger', '1.5u'),
# ('l_M35', '1.0u'), ('nf_M35', '3'), ('w_M36_per_finger', '1.5u'), ('l_M36', '0.5u'), ('nf_M36', '3'),
# ('w_M17_per_finger', '1.5u'), ('l_M17', '1.0u'), ('nf_M17', '2'), ('w_M18_per_finger', '1.0u'), ('l_M18', '1.5u'),
# ('nf_M18', '2'), ('w_M11_per_finger', '0.5u'), ('l_M11', '0.5u'), ('nf_M11', '2'), ('w_M12_per_finger', '1.5u'),
# ('l_M12', '1.0u'), ('nf_M12', '1'), ('w_M19_per_finger', '1.5u'), ('l_M19', '1.0u'), ('nf_M19', '3'),
# ('w_M20_per_finger', '1.0u'), ('l_M20', '1.0u'), ('nf_M20', '1'), ('w_M21_per_finger', '1.0u'), ('l_M21', '1.0u'),
# ('nf_M21', '1'), ('w_M22_per_finger', '0.5u'), ('l_M22', '1.5u'), ('nf_M22', '2'), ('IB', '50.0u')])
